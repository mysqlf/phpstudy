seajs.use(['/Assets/Home/js/lib/jquery-2.1.4.min','/Assets/Home/js/lib/tools.min.js','/Assets/Home/js/plug/scrollListener/jquery.scrollListener','/Assets/Home/js/plug/layer.m/layer.m','/Assets/Home/js/plug/validate/jquery.validate.min','/Assets/Home/js/plug/scrollAjax/scrollAjax','/Assets/Home/js/plug/lazyload/lazyload','/Assets/Home/js/plug/hammer/hammer.min','/Assets/Home/js/plug/stickUp/stickUp.min','/Assets/Home/js/plug/popup/popup'],function($,tool,scrollListener,layer){
		$(function(){
			tool.limitHeight();
			$('.stick-up').stickUp();
			$('form input[type="submit"]').prop('disabled',false);
			var panup = new Hammer($('body')[0],{threshold :0});
                panup.on('panup',function(){
	             //妈妈帮
				 $(window).scrollListener({

			        	scrollEnd : function(top,maxH,el){
			        		$('#P_mamabang .shuoshuo-box').scrollAjax({
			              		ajax : {
			              			url : 'Homemaking-motherBabyQA',
			              		},
			              		html : function(data){
			              			 var html = replyHtml = '',
			              			     detailUrl = 'Homemaking-motherBabyQADetail-v-' + $.now() + '-id-';
	                
				                         for(var i = 0,len = data.length; i < len; i++){

				                              var curData = data[i],
				                                  isLike = curData.isLike,//没点赞是0 已点赞1
				                                  replyArr = curData.reply;
				                               
				                               if(replyArr){
				                                  replyHtml = '<div class="reply-box">';

				                               	  for(var j = 0,len2 = replyArr.length ; j < len2 ; j++ ){

					                                    replyHtml +=  '<p class="text-overflow"><span class="c-brand">'+ replyArr[j].fldOpenName +'：</span>'+ replyArr[j].fldContent +'</p>'
					                         	   }

					                         	   replyHtml += '</div>';
				                               }
				                         	   

					                           html += '<li class="horizontal"  data-id="'+ curData.fldId +'"><div class="left">'
					                                +  '<img class="lazy img-responsive" src="/Assets/Home/images/lazy.gif"  data-original="'+ curData.PhotoUrl +'" alt="">'
					                                +  '</div><div class="right">'
					                                +  '<a href="'+ detailUrl + curData.fldId +'" title="" target="_blank">'
					                                +  '<h2 class="title c-brand">'+ curData.fldOpenName +'</h2>'
					                                +  '<div class="limit-h limit-3"><p class="limit-content">' + curData.fldContent + '</p></div>'
					                                +  '</a><div class="clearfix footer">'
					                                +  '<span>'+ curData.fldCreateDate +'</span>'
					                                +  '<a class="pull-right pinglun-btn" href="'+ detailUrl + curData.fldId +'" title="" target="_blank"><i class="icon icon-pinglun-gray"></i>'+ curData.fldReplyNum +'</a>'
					                                +  '<a href="javascript:;" class="pull-right zan-btn '+ (isLike ? 'isLike' : '') +'"><i class="icon"></i><span class="txt">'+ curData.fldLikeNum +'</a></span>'
		                                            +  '</div>'
		                                            +  replyHtml
		                                            +  '</div></li>'

							                        replyHtml = '';   

				                               }

				                          return html;     
				              		},
			              		success : function(){

                                    tool.limitHeight();
			          				$('img.lazy').lazyload();
			              			
			              		}
			                });
			            }		
			        });
			        
	            //妈妈帮详情
				 $('#scroll-box').scrollListener({
			        	scrollEnd : function(top,maxH,el){

			        		$('#P_mamabangDetail .shuoshuo-box').scrollAjax({
			              		ajax : {
			              			url : 'Homemaking-motherBabyQADetail',
								    data : {
								    	id : $("input[name='id']").val()
								    }
			              		},
			              		html : function(data){
			              			
			              			 var html  = '',
			              			     index = $('.shuoshuo-box>li').length;
			              			     //detailUrl = 'Homemaking-motherBabyQADetail-v-' + $.now() + '-id-';
	                
				                         for(var i = 0,len = data.length; i < len; i++){

				                              var curData = data[i],
				                                  isAuthor = curData.isAuthor,
				                                  authorHtml = isAuthor == 0 ?  '' : '<span class="tag-author pull-left">楼主</span>';//0非楼主 1楼主
					                           html += '<li class="horizontal" ><div class="left">'
					                                +  '<img class="lazy img-responsive" src="/Assets/Home/images/lazy.gif"  data-original="'+ curData.PhotoUrl +'" alt="">'
					                                +  '</div><div class="right"> <div class="text-overflow">'
					                                //+  '<a href="'+ detailUrl + curData.fldId +'" title="" target="_blank">'
					                                +  '<span class="name c-brand pull-left">'+ curData.fldOpenName +'</span>'
					                                +  '<span class="pull-left">'+ (++index) +'楼</span>'
					                                +  authorHtml
					                                +  '</div><div class="limit-h limit-3"><p class="limit-content">'
					                                +  curData.fldContent
					                                +  '</p></div><div class="read-all text-right dn"><i class="icon icon-arrow-down-pink"></i></div>'
					                                //+  '</p><div class="read-all text-right dn"><i class="icon icon-arrow-down-pink"></i></div></a>'
		                                            +  '</div></li>'

				                               }

				                          return html;     
				              		},
			              		success : function(){
			              			tool.limitHeight();
			          				$('img.lazy').lazyload();
			              			
			              		}
			                });
			            }		
			        });
             });

            //点赞
            $('body').on(tool.events.tap,'.shuoshuo-box .zan-btn',function(){
                  var $this = $(this);
                  var $txt = $this.find('.txt');
                  var isLike = $this.hasClass('isLike');
                  var $scope = $this.closest('li');
                  var id = $scope.data('id');
                  var flag = $this.data('flag');

                  if(flag) return;
                  $this.data('flag',true);
                  $.ajax({
                  	type:'post',
                  	url:'Homemaking-motherBabyQALike',
                  	dataType:'json',
                  	data:{
                       id : id
                  	},
	                timeout : 6000,
	                error : function(){
	                    layer.open({
	                  			content:'服务器繁忙',
	                  			time:2
	                  		});
	                    $this.data('flag',false);
	                  },
                  	success:function(ret){

                  	  if(ret == 'true'){
                  	  	  var num = parseInt($txt.text());
	                      if(isLike){
	                      	 $this.removeClass('isLike');
	                      	 num--;
	                      } else{
	                      	$this.addClass('isLike');
	                      	num++;
	                      }
	                       $txt.text(num);
	                       
	                  	} else{
	                  		layer.open({
	                  			content:'操作失败',
	                  			time:2
	                  		});
	                  	}
	                  	$this.data('flag',false);
                  	  }
                  });

            })

            //删除
            $('body').on(tool.events.tap,'.shuoshuo-box .del-btn',function(){
                  var $this = $(this);
                  var $scope = $this.closest('li');
                  var id = $scope.data('id');
                  var flag = $this.data('flag');
                 
                  var layerTip = layer.open({
                  	content:'确认要删除该提问？',
                  	 btn: ['确认', '取消'],
                  	 yes : function(){
                  		  if(flag) return;
		                  $this.data('flag',true);
		                  $.ajax({
		                  	type:'post',
		                  	url:'Homemaking-motherBabyQADelete',
		                  	dataType:'json',
		                  	data:{
		                       id : id
		                  	},
			                timeout : 6000,
			                error : function(){

			                    layer.open({
			                  			content:'服务器繁忙',
			                  			time:2
			                  		});
			                    $this.data('flag',false);
			                    
			                  },
		                  	success:function(ret){
		                      var tip = '删除失败';
                              

		                  	  if(ret == 'true'){
			                  	tip = '删除成功';
			                  	location.href="/Homemaking-motherBabyQA";
			                  	}
			                  	layer.open({
			                  			content:tip,
			                  			time:2
			                  		});
			                  	$this.data('flag',false);

		                  	  }
		                      
		                  });
                  	}
                  })

                  


            })
             //评论
             $('#P_mamabangDetail').on(tool.events.tap,' .shuoshuo-box .pinglun-btn',function(){
                 $('.public-box .form-control').focus();
             })
             var custom_validate = $('#shuoshuo-form,.shuoshuo-form').validate({
             	    submitHandler : function(form){
             	    	$(form).find('input[type="submit"]').prop('disabled','disabled');
             	    	form.submit();
             		},
		         	errorPlacement: function(error, element) {  
					    error.appendTo(element.parent().parent());  
					},
			        messages : {
			          shuoshuo : {
			               required : '内容不能为空',
			               maxlength : '不能超过500个字'
			               }
			        }
			      });


            $('.shuoshuo-form .input-toggle,.shuoshuo-form .public-btn').on(tool.events.tap,function(){
           	   var $this = $(this),
                   location2 = $('#location').val();
                   var html = '<section class="public-box2">'
           	   	         + '<form class="shuoshuo-form" action="Homemaking-motherBabyQAIssue" method="post" novalidate="novalidate">'
           	   	         + '<div class="flex-box topBar"><div><input class="btn btn-cancle" type="button" value="取消"></div><div class="text-center">发表问答</div> <div class="text-right"><input  class="btn public-btn" type="submit" value="发表"></div></div>'
           	   	         + '<div class="horizontal horizontal-r"></div>'
           	   	         + '<div class="left"><textarea class="form-control textarea input-toggle" name="shuoshuo" maxlength="500" required="" placeholder="请在此阐述您的疑问，字数500字以内" ></textarea>'
           	   	         + '<input id="location2" type="hidden" name="location" value="'+ location2 +'"></div>'
           	   	         +  (location2 ? '<div class="location">地点：'+ location2 +'</div>' : '' )
           	   	         +'</div></form></section>';
           	   	    var $publicPopup = $('<div id="public-popup">');

                    
           	   	    $publicPopup.html(html).appendTo('body').show();
           	   	    $('html,body').addClass('win_lock');
           	   	    $('.public-box1').hide();

           	   	    //获取地址

                     if(!location2){
                     	var locationTime = 30;
                        var locationTimer = setInterval(function(){
                        	location2 = $('#location').val();
                        	--locationTime;
	                        if( location2 || locationTime <= 0){
	                        	if (location2) {
	                        		//$('.public-box2 .shuoshuo-form .location').remove();
	                        		$('.public-box2 .shuoshuo-form').append('<div class="location">地点：'+ location2 +'</div>' );
	                        	}
                                 clearInterval(locationTimer);
	                          }
	           	   	   },1000);
                     }
	           	   	   
           	   	    setTimeout(function(){
           	   	    	$(window).scrollTop(0);
           	   	    },0);

           	   	    var $form = $('.public-box2 .shuoshuo-form');

                    $form.find('.input-toggle').focus();
                    $form.find('.btn-cancle').on(tool.events.tap,function(){
                    	$publicPopup.remove();
                    	$('html,body').removeClass('win_lock');
                    	$('.public-box1').show();
                    	$(window).scrollTop(1);
                    	
                    });

           	   	    $form.validate({
	             	    submitHandler : function(form){
	             	    	$(form).find('input[type="submit"]').prop('disabled','disabled');
	             	    	form.submit();
	             		},
			         	errorPlacement: function(error, element) {  
						    error.appendTo(element.parent().parent());  
						},
				        messages : {
				          shuoshuo : {
				               required : '内容不能为空',
				               maxlength : '不能超过500个字'
				               }
				        }
				      });

           	   })
		})
	})