seajs.use(['/Assets/Home/js/lib/jquery-2.1.4.min','/Assets/Home/js/lib/tools.min','/Assets/Home/js/plug/popup/popup','/Assets/Home/js/plug/layer.m/layer.m','/Assets/Home/js/plug/mobiscroll/mobiscroll','/Assets/Home/js/plug/validate/jquery.validate.min'],function($,tool,popup,layer){
		$(function(){
      
      var codeTime = parseInt($('#time-code').val());
      var codeTimer = null;
      if(codeTime){
         var $codeBtn = $('#get-code-btn');
             $codeBtn.data('disabled','true');
             countTime($codeBtn,codeTime);
             codeTimer = setInterval(function(){
               countTime($codeBtn);
             },1000);
      } else{
        codeTime = 119;
      }


      var currYear = (new Date()).getFullYear(); 
      var opt={};
      opt.date = {preset : 'date'};
      opt.default = {
        theme: 'android-ics light', //皮肤样式
        startYear: currYear - 18, //开始年份
        endYear: currYear + 1 //结束年份
      };

      $('#dueDate').mobiscroll($.extend(opt['date'], opt['default']));
      //修复 validate 插件的值不改变
      $('#dueDate').on('change',function(){
          $(this).blur();
      });

      function countTime(obj){

                 if(codeTime == 0){
                     clearTimeout(codeTimer);
                     codeTime = 119;
                     obj.html('重新发送');
                     obj.data('disabled','false').removeClass('disabled');
                 }
                 else{
                     obj.html('('+codeTime + 's）后重发').addClass('disabled');
                     codeTime--;
                 }
         }
      
      $('form input[type="submit"]').prop('disabled',false);
      var custom_validate = $('#custom_form').validate({
        submitHandler : function(form){
          if($('#P_custom_form').length){
               $.ajax({
                   url: 'Homemaking-isAllowReg',  
                   type: "post",       
                   dataType: "json",      
                   data: {   
                     'phone' :  $("#phone").val()
                   } ,
					timeout:60000,
					error:function(){
					alert('服务器繁忙');
					},
             success : function(ret){
                  if(ret == 'logged' ){
                     $(form).find('input[name="operateType"]').val('logged');
                     $(form).find('input[type="submit"]').prop('disabled','disabled');
                     form.submit();
                  }else if(ret == 'allowReg' ){
                     $(form).find('input[name="operateType"]').val('reg');
                     $(form).find('input[type="submit"]').prop('disabled','disabled');
                     form.submit();
                  }  else if(ret == 'forbidReReg' ){
                    layer.open({
                       content : '手机号已注册智通通行证<br/>登录通行证进行绑定？',
                       btn : ['登录','取消'],
                       yes : function(){
                         $(form).find('input[name="operateType"]').val('login');
                         $(form).find('input[type="submit"]').prop('disabled','disabled');
                         form.submit();
                       }
                     })
                  } else if(ret == 'allowReReg' ){
                    layer.open({
                       content : '该手机账号已经存在<br/>继续注册会导致原先的账号无法正常使用！',
                       btn : ['继续注册','登录'],
                       yes : function(){
                         $(form).find('input[name="operateType"]').val('reReg');
                         $(form).find('input[type="submit"]').prop('disabled','disabled');
                         form.submit();
                       },
                       no : function(){
                         $(form).find('input[name="operateType"]').val('login');
                         $(form).find('input[type="submit"]').prop('disabled','disabled');
                         form.submit();
                       }
                     })
                  }
             }  
           })    
          } else{
          	$(form).find('input[type="submit"]').prop('disabled','disabled');
            form.submit();
          }     
            },
         
        rules : {
          user : 'zh_cn',
          phone : 'istelephone',
          code : {
             remote: {
                    url: 'Account-code',  //后台处理程序
                    type: "post",        //数据发送方式
                    dataType: "json",      //接受数据格式   
                    async: false,
                    data: {          //要传递的数据
                      'codeVal' : function() {
                          return $("#code").val();
                        },
                       'phoneVal' : function() {
                          return $("#phone").val();
                        }
                    }
               }
          },
          'certificate1[]' : {
            minlength : 1,
            required : true
          },
          verify: {
            remote: {
                    url: 'Homemaking-checkVerify',  //后台处理程序
                    type: "post",        //数据发送方式
                    dataType: "json",      //接受数据格式  
                    async: false
               }
          }
               
        },
        messages : {
          verify: {
            required : '请输入验证码',
            remote: '验证码不正确'
          },
          user : {
               required : '请输入您的称呼'
               },
          phone : {
               required : '请输入手机号',
               maxlength : '手机号码不能超过11位'
               },
          place  : {
               required : '请选择地区'
          } ,   
          placeDetail : {
               required : '请输入您的详细地址',
               maxlength : '详细地址长度不能超过11位'
          } ,
          code  : {
               required : '请输入手机验证码',
               remote : '手机验证码不正确',
               number : '只支持数字'
          } ,   
          dueDate  : {
               //required : '请选择' + $('#dueDate').attr('placeholder')
               required : '请选择时间'
          } ,  
          
          price : {
            required : '请选择服务价格'
          },
          native : {
            required : '请选择籍贯'
          },
          age : {
            required : '请选择年龄'
          },
          marry : {
            required : '请选择婚姻'
          },
          language : {
            required : '请选择语言能力'
          },
          special : {
            maxlength : '特殊备注不能超过20个字'
          }
        }
      });

      $('#get-code-btn').on(tool.events.tap,function(){
        var $this = $(this);

          if ( custom_validate.element('#phone') && custom_validate.element('#captcha')) {

            countTime($this,codeTime);
            $.ajax({
              type:'post',
              url: 'Homemaking-getcode',
              data: {
                 phoneVal : $('#phone').val(),
                 verify: $('#captcha').val()
              },
              dataType:'json',
              timeout:60000,
              error:function(){
                alert('服务器繁忙');
              },
              success:function(json){
                if(json.status - 0 === 1){
                  codeTimer = setInterval(function(){
                     countTime($this);
                  },1000);
                } else if(json.status - 0 === 0 && json.info){
                    layer.open({
                       content : json.info,
                       time: 3
                     })
                }
              }

            })

          }
      })

      //下拉初始化
			 $('.down-select').each(function(){
			 	var $this = $(this);
			 	var data = $this.data('select');
			 	var html = createSelectList(data);
			 	$this.popup({
	             	content : html
	             });
			 });
       
       //生成下拉列表
       function createSelectList(str){
        var data = str.split(','),
            html ='<ul class="select-list">',
            isNoLimit = data[0]=='不限';
           if(isNoLimit){
             for(var i=0,len=data.length; i < len; i++){
                html += '<li><a href="javascript:;" data-value = '+ i +'>'+data[i]+'</a></li>'
              };
           } else{
             for(var i=0,len=data.length; i < len; i++){
                  html += '<li><a href="javascript:;" data-value = '+ (i+1) +'>'+data[i]+'</a></li>'
                };
           }
          

        html += '</ul>';
        return html;

       }
      
      $('.down-select-place').each(function(){
          var $this = $(this);
          $this.popup({
                        content : '<div class="data-loading"><img class="img-responsive" src="/Assets/Home/images/loading.gif">数据加载中...</div>',
                        className : 'place-popup'
                       });
          $this.on(tool.events.tap,function(){
              var isdata =  $this.data('data');
                  

              if(!isdata){ 
                   var cachList = checkPlaceList(0);

                   if(cachList.hasHtml){//如果存在缓存 直接取缓存
                      $('.place-popup .popup-content').html(cachList.html);
                      $this.data('data',true);
                       return;
                    }
                   sendPlaceAjax('http://weixin.hr5156.com/Ptime-areaSelect',{code : 0},$this,function(json,ajaxdata){
                    placeCallBack(json,ajaxdata,$this);
                  });
                }
          });
      })

      $('body').on(tool.events.tap,'.select-list-place>li',function(){

          var $this = $(this),          
              $scope = $this.closest('.select-list-place'),
              $a = $this.find('>a'),
              html = '',
              code = $a.data('code'),
              cachList = checkPlaceList(code);

              $scope.find('li').removeClass('active');
              $this.addClass('active'); 
              $scope.nextAll().remove();
              if(cachList.hasHtml){//如果存在缓存 直接取缓存
                 $scope.after(cachList.html);
                 return;
              };

              if($a.hasClass('hasChild')){ 
                    sendPlaceAjax('http://weixin.hr5156.com/Ptime-areaSelect',{code : code},$this,function(json,ajaxdata){
                    placeCallBack(json,ajaxdata,$this.closest('.popup').data('popup-toggle'),$scope)
                  });
              } else{
                var arr = [];
                    $scope.parent().find('li.active>a').each(function(){
                    arr.push($(this).html());
                })
                
                $('#place').val(arr.join(''));
                
                $scope.closest('.popup').data('popup-toggle').popup('close');

              }
      });
	//检出缓存地址列表
      function checkPlaceList(codes){

        var  palceJsonTemp = localStorage.palceJsonTemp ? JSON.parse(localStorage.palceJsonTemp) : {},//缓存地址列表
             html = '',
             hasHtml = false,
             code = codes + '';

             for(prop in palceJsonTemp){//查找是否存在缓存

                    if(prop == code){

                      hasHtml = true;
                      html =  palceJsonTemp[prop];
                      break;
                    }
                  }
            return {hasHtml : hasHtml , html : html}      
      }
      //发送获取地址ajax
      function sendPlaceAjax(url,ajaxdata,$this,callBack){
         $.ajax({
                type:'post',
                url: url,
                data: ajaxdata,
                dataType:'json',
                timeout:60000,
                error:function(){
                  alert('服务器繁忙');
                  $this.popup('close');
                },
                success:function(json){
                  callBack(json,ajaxdata);
                  } 
              });   
      }

      //获取地址成功回调
      function placeCallBack(json,ajaxdata,$this,$scope){

            var data = json,
                html = '<ul class="select-list-place col-4">',
                temp = localStorage.palceJsonTemp ? JSON.parse(localStorage.palceJsonTemp) : {},
                $popup = $('#popup'+ $this.data('popupid') +' .popup-content');

            if(!data) return;
            $('.data-loading').remove();
            $this.data('data','true');

            html += createPlaceLi(data);
    
            temp[ajaxdata.code] = html;
            localStorage.palceJsonTemp = JSON.stringify(temp);
            if($scope){
              $scope.nextAll().remove().end().after(html);
            } else{
              $popup.append(html);
            }
           
      }
      //生成地址列表
      function createPlaceLi(data){
        var html = '';
         for(var i = 0,len = data.items.length; i < len; i++){
                      var name =  data.items[i].name;
                      var code = data.items[i].code;
                      var className = parseInt(data.items[i].hasChild) > 0 ? 'class = "hasChild"' : '';
                      html +='<li><a ' + className + ' href="javascript:;" data-code="'+code+'" title="' + name + '">' + name + '</a></li>'
                  }
                html += '</ul>';
                return html;

      }

      //下拉选择点击
       $('body').on(tool.events.tap,'.select-list li>a',function(){
           var $this = $(this);
           var $toggle =$this.closest('.popup').data('popup-toggle');//获取触发popup的对应元素
           var val = $this.html();
           var index = $this.data('value');

           $toggle.find('.form-control').val(val).blur();;
           $toggle.find('.input-hidden').val(index);
           $toggle.popup('close');
         })
       
       $('body').on(tool.events.tap,'.select-list li>a',function(){
           var $this = $(this);
           var $toggle =$this.closest('.popup').data('popup-toggle');//获取触发popup的对应元素
           var $price = $toggle.find('#price') 

               if($price.length){
                 createTag($this.html());
                }

       })
//生成标签列表
function createTag(val){
        var type = $('#type-box input:checked').data('type');
        var val = parseInt(val);
        var html = '',
            data = null;

        data = $('#J_tag').data('tag');
        if(type == 1 ){
           data = data[1]
        } else{
          data = data[2]
        }
        for (prop in data){
           if(val == prop){
              var tag =  data[prop];
              for (prop1 in tag){
                     html += '<span class="tag tag-style'+tag[prop1]+'">' + prop1 + '</span>' 
              }

           }
        }
        if(html){
          $('#J_tag').html(html).show(); 
        } else{
           $('#J_tag').hide();
        }
}


       //单选
       $('body').on(tool.events.tap,'#P_custom_form .J_radio input[type="radio"]',function(e){
          var $this = $(this),
              $scope = $this.closest('.J_radio'),
              $label = $this.closest('label'),
              type = $this.data('type'),
              html = '',
              dueDate = type==1 ? '预产期' : '宝宝生日',
              $price = $('#price').closest('.down-select'),
              priceStr = type==1 ? $price.data('select') : $price.data('select2'),
              priceHtml = createSelectList(priceStr);
              $labelAll = $scope.find('label');


              if($this.is(':checked')){
                $labelAll.removeClass('active');
                $label.addClass('active');


                $('#price').val('');
                $('#J_tag').hide();
                $('#dueDate').attr('placeholder',dueDate);

                $('#popup'+ $price.data('popupid') +' .popup-content').html(priceHtml);

              }   
       })
       //单选
       $('body').on(tool.events.tap,'.J_radio input[type="radio"]',function(e){

          var $this = $(this),
              $scope = $this.closest('.J_radio'),
              $label = $this.closest('label'),
              $labelAll = $scope.find('label');

              if($this.is(':checked')){
                $labelAll.removeClass('active');
                $label.addClass('active');
              }  
       })

       //全选
       $('body').on(tool.events.tap,'.J_checkbox input[type="checkbox"]',function(e){
          var $this = $(this),
              $scope = $this.closest('.J_checkbox'),
              $label = $this.closest('label');
              if($this.is(':checked')){
                $label.addClass('active');
              } else{
                $label.removeClass('active');
              }     
       });
       //培训报名单选
       $('#P-apply').on(tool.events.tap,'.J_radio.course-box input[type="radio"]',function(e){

          var $this = $(this),
              price = $this.data('price');

              if($this.is(':checked')){
                  $('#price-show').show().find('.course-txt').html('￥' + price);
              }  
       })
       //竞聘月嫂 类型变化 证件变化
       $('#P-competeSitter').on(tool.events.tap,'#type-box.J_radio input[type="radio"]',function(e){
           var $this = $(this),
               type = $this.data('type');

              if($this.is(':checked')){
                if(type==1){
                  $('.certificate-box1').show().find('input').prop('disabled',false);
                  $('.certificate-box2').hide().find('input').prop('disabled','disabled');
                } else{
                  $('.certificate-box1').hide().find('input').prop('disabled','disabled');;
                  $('.certificate-box2').show().find('input').prop('disabled',false);
                }
              } 

       })
		})	
	})