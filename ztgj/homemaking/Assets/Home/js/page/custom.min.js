//seajs.use(['./js/lib/jquery-2.1.4.min','./js/lib/tools.min','./js/plug/scrollListener/jquery.scrollListener','./js/plug/lazyload/lazyload','./js/plug/popup/popup'],function($,tool,scrollListener,popup){
seajs.use([
	'/Assets/Home/js/lib/jquery-2.1.4.min', 
	'/Assets/Home/js/lib/tools.min', 
	'/Assets/Home/js/plug/scrollListener/jquery.scrollListener', 
	'/Assets/Home/js/plug/scrollAjax/scrollAjax.js', 
	'/Assets/Home/js/plug/lazyload/lazyload', 
	'/Assets/Home/js/plug/hammer/hammer.min', 
	'/Assets/Home/js/plug/popup/popup', 
	'/Assets/Home/js/plug/mobiscroll/mobiscroll', 
	'/Assets/Home/js/plug/stickUp/stickUp.min'], function($, tool, scrollListener, popup) {
    $(function() {
        $('.stick-up').stickUp();
        $('.goTop').on(tool.events.tap, function() {
            $('body,html').animate({
                scrollTop: 0
            }, 500)
        })
        $('.down-select').each(function() {
            var $this = $(this);
            var data = $this.data('select').split(',');
            var html = '<ul class="select-list" data-target="#' + $this.attr('id') + '">';

            for (var i = 0, len = data.length; i < len; i++) {
                html += '<li><a href="javascript:;">' + data[i] + '</a></li>'
            };
            html += '</ul>';
            $this.popup({
                content: html
            });
        })
        var currYear = (new Date()).getFullYear();
        var opt = {};
        opt.date = {
            preset: 'date'
        };
        opt.default = {
            theme: 'android-ics light', //皮肤样式
            startYear: currYear - 18, //开始年份
            endYear: currYear + 1 //结束年份
        };

        $('.input-date').mobiscroll($.extend(opt['date'], opt['default']));


        $('body').on(tool.events.tap, '.select-list li>a', function() {
            var $this = $(this);
            var $target = $($this.closest('.select-list').data('target'));
            var sortObj = null;

            $target.find('.value').html($this.html());
            $target.popup('close');

            sortObj = getSortValue();
            location.href = dealUrl({
                'pay': sortObj.pay,
                'place': sortObj.place,
                'date': sortObj.date,
                'locations': sortObj.locations
            });
        })

        $('img.lazy').lazyload();

        $('body').on(tool.events.tap, '.date-toggle', function() {
            var $this = $(this),
                $date = $this.find('.input-date'),
                date = '',
                pay = $('#sort-pay .value').html(),
                place = $('#sort-place .value').html(),
                dateObj = new Date(),
                time = dateObj.getFullYear() + '-' + (dateObj.getMonth() + 1) + '-' + dateObj.getDate();

            $date.attr('min', time)
            $date.on('change', function() {
                date = $date.val();
                $('#sort-date .value').html(date);
                sortObj = getSortValue();
                location.href = dealUrl({
                    'pay': sortObj.pay,
                    'place': sortObj.place,
                    'date': sortObj.date,
                    'locations': sortObj.locations
                });
            })
        })
        var panup = new Hammer($('body')[0], {
            threshold: 0
        });
        panup.on('panup', function() {

            $(window).scrollListener({
                scrollEnd: function(top, maxH, el) {
                    var type = $('#P_custom .sort-box .tab-nav .active').data('type') || '月嫂';
                    var typeNum = (type == '月嫂' ? 1 : 2);
                    var data = $.extend({}, {
                        type: type
                    }, getSortValue());
                    $('.yuesao-list').scrollAjax({
                        ajax: {
                            url: 'Homemaking-requirement',
                            data: data
                        },
                        noMoreTxt: '更多月嫂/育婴嫂信息请致电：4008-559-557,<br>或到附近的智通到家门店咨询！',
                        html: function(data) {
                            var html = '',
                                certificate = '',
                                len = data.length,
                                detailUrl = '/Homemaking-requirementDetail-type-' + typeNum + '-v-' + $.now();

                            for (var i = 0; i < len; i++) {
                                var arr = data[i].homemaking_certificate;
                                var style = 1;

                                if (arr) {
                                    certificate = '<div class="tag-box c-gray text-left">证件：';
                                    for (var j = 0, len2 = arr.length; j < len2; j++) {

                                        switch (arr[j]) {
                                            case '身份证':
                                                style = 1;
                                                break;
                                            case '月嫂证':
                                                style = 2;
                                                break;
                                            case '健康证':
                                                style = 3;
                                                break;
                                            case '催乳师证':
                                                style = 4;
                                                break;
                                            default:
                                                style = 1;
                                        }
                                        certificate += '<span class="tag tag-style' + style + '">' + arr[j] + '</span>';
                                    }
                                    certificate += '</div>';
                                }

                                var takeBabyNum = data[i].fldTakeBabyNum !== undefined ? '<div class="col-12">带过几个宝宝：<span class="c-gray-light">' + (data[i].fldTakeBabyNum ? data[i].fldTakeBabyNum + '个' : "未设置") + '</span></div>' : '';
                                var workYears = data[i].fldWorkYears !== undefined ? '<div class="col-12">工作年限：<span class="c-gray-light">' + (data[i].fldWorkYears ? data[i].fldWorkYears : "未设置") + '</span></div>' : '';

                                html += '<li><a href="' + detailUrl + '-id-' + data[i].fldID + '" class="panel">' + '<div class="panel-body horizontal"><div class="yuesao-head left"><img class="img-responsive lazy" src="/Assets/Home/images/lazy.gif" data-original="' + data[i].fldPhotoUrl + '" alt=""></div>' + '<ul class="right yuesao-info">' + '<li class="clearfix"><span class="col-3">' + data[i].fldName + '</span> <span class="col-9 text-right c-brand">' + (data[i].fldPrice ? (data[i].fldPrice + (typeNum == 1 ? '元/26天' : '元/月')) : "未设置") + '</span></li>' + '<li class="clearfix">' + '<div class="col-12 text-overflow"><span class="c-gray-light">' + parseInt(data[i].fldage) + '岁</span>' + '<span class="c-gray-light"> ' + ( data[i].chineseZodiac ? '属' + data[i].chineseZodiac : '')  + ' </span>' + '<span class="c-gray-light"> ' +  (data[i].constellation || '')  + '</span>' + ' <span class="c-gray-light">' + data[i].fldNative + '</span></div>' + takeBabyNum + workYears + '<div class="col-12 text-overflow">拿手菜：<span class="c-gray-light">' + (data[i].fldSpecialtyDish ? data[i].fldSpecialtyDish : "未设置") + '</span></div>' + '<div class="col-12">语言能力：<span class="c-gray-light">' + (data[i].fldLanguage ? data[i].fldLanguage : "未设置") + '</span><span class="pull-right c-gray-light"><i class="icon icon-pinglun-gray"></i>' + data[i].homemakingServiceCommentNum + '</span></div>' + '</li></ul></div>' + '<div class="panel-footer">'

                                + certificate
                                    + '</div></a></li>'
                            }
                            return html;
                        },
                        success: function() {
                            $('img.lazy').lazyload();
                        }
                    });
                }
            })

        })

        function getSortValue() {
            var pay = $('#sort-pay .value').text(),
                place = $.trim($('#sort-place .value').text()),
                date = $.trim($('#sort-date .value').text().split('-').join(',')),
                locations = $('#sort-place2 .value').text(),
                place = place == $('#sort-place .value').data('temp') ? null : place,
                locations = locations == $('#sort-place2 .value').data('temp') ? null : locations,
                date = (isNaN(parseInt(date)) && date != '不限') ? null : date;

            if (pay != '不限') {
                pay = parseInt(pay);
                pay = isNaN(pay) ? null : pay;
            }

            return {
                pay: pay,
                place: place,
                date: date,
                locations: locations
            }
        }

        function dealUrl(obj) {
            //var href = location.href,
            var href = location.href.replace(/[&?=]/g, '-'),
                urlStr = '';

            if (obj) {

                for (prop in obj) {
                    if (href.lastIndexOf('-' + prop) != -1) {
                        href = href.substring(0, href.lastIndexOf('-' + prop));
                    }
                    urlStr += '-' + prop + '-' + obj[prop];
                }
            }
            href += urlStr;
            return href;
        }
    });
})
