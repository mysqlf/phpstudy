//seajs.use(['/Assets/Home/js/lib/jquery-2.1.4.min','/Assets/Home/js/lib/tools.min','/Assets/Home/js/plug/layer.m/layer.m','/Assets/Home/js/page/imagelightboxInit.js','/Assets/Home/js/plug/validate/jquery.validate.min','/Assets/Home/js/plug/lazyload/lazyload','/Assets/Home/js/plug/liteuploader/liteuploader'],function($,tool,layer,imagelightbox){
seajs.use(['/Assets/Home/js/lib/jquery-2.1.4.min','/Assets/Home/js/lib/tools.min','/Assets/Home/js/plug/layer.m/layer.m','/Assets/Home/js/page/imagelightboxInit.js','/Assets/Home/js/plug/validate/jquery.validate.min','/Assets/Home/js/plug/lazyload/lazyload','/Assets/Home/js/plug/liteuploader/liteuploader','/Assets/Home/js/plug/popup/popup', '/Assets/Home/js/plug/pinchzoom/pinchzoom.min', '/Assets/Home/js/plug/pinchzoom/swipe.min'],function($,tool,layer,imagelightbox){
	$(function(){
    $('form input[type="submit"]').prop('disabled',false);
		$('body').on(tool.events.tap,'.select-wrap .lattice-el',function(){
			var $this =$(this);
			$('.select-wrap .lattice-el').removeClass('active');
			$this.addClass('active');
		})
		$('body').on(tool.events.tap,'.select-box>li input[type="radio"]',function(e){
			var $this =$(this);
			var $scope = $this.closest('.lattice-el');
			var type = $this.data('type');
			var $selectBox = $this.closest('.select-box');
			var $icon = $scope.find('.icon').eq(0);
			var icon = 'icon icon-';

			switch(type){
				case 1 : icon += 'you'; break;
				case 2 : icon += 'liang'; break;
				case 3 : icon += 'cha'; break;
			}

			$icon[0].className = icon;

			e.stopPropagation();
            $scope.removeClass('active');

			if($this.is(':checked')){
				$scope.removeClass('error');
				$selectBox.find('.icon').removeClass('active');
                $this.nextAll('.icon').addClass('active');
			}
			
		})
       $('img.lazy').lazyload();
       //imagelightbox.init();

	$('body').on('click','.page .close-icon',function(){
		$("body").css({'overflow':''});
		$('.page').remove();
	});

	$('.imagelightbox li>a').click(function(){
		$("body").css({'overflow':'hidden'});
		var $imagelightbox = $(this).closest('.imagelightbox');
		var $imagelightboxList = $imagelightbox.find('li>a');
		var index = $imagelightboxList.index(this);
		//var id = $imagelightbox.data('target');
		//$('body').append($(id).html());
		$('body').append($('#slider-comment').html());
		
		$('div.pinch-zoom').each(function () {
			new RTP.PinchZoom($(this), {});
		});
		window.mySwipe = new Swipe(document.getElementById('slider'), {
			startSlide : index,
			continuous : true,//循环轮播
			disableScroll: false,
			speed: 400
		});
		return false;
		//mySwipe.slide(index);
	})
			
		//图片上传
		$('#upload-open').on(tool.events.tap,function(){
             $('.add-img').toggleClass('dn');
		})
		var cid = $('#cid').val();
		$('.upload-btn').liteUploader({
			script: '/Homemaking-upload',
			params: {
				cid : cid
			},
			rules: {
		            allowedFileTypes:'image/jpg,image/jpeg,image/gif,image/png',
		            maxSize: 2*1024*1024
		        }
			}).on('lu:progress',function(e,percentage){
        
        var $this =  $(this);
        var $scope =  $this.closest('.img-box');
        $this.prop('disabled','disabled');
        if($scope.find('.img-percentage').length){
        	$scope.find('.img-percentage').html(percentage + '%');
	    }else{
			$('<div class="img-percentage">').html(percentage + '%').appendTo($scope);
	    }
        $this.data('staute','loading');
        $('#img-staute').val(1);

      }).on('lu:success', function (e, response) {
          var tip = '上传图片失败';
          var data = $.parseJSON(response);
          var $this =  $(this);
          var $scope =  $this.closest('.img-box');
          var flag = true;
          if(response != 'false'){
                $scope.find('img').attr('src',data.src);
                $scope.find('.del-img').data('imgid',data.id).show();
                tip = '上传图片成功'
		    } else{
		       $this.prop('disabled',false);
		    }

          layer.open({
                  content:tip,
                  time:2
                });
				  
          $this.data('staute','ok');
          $('.add-img .upload-btn').each(function(){
	          if($(this).data('staute') == 'loading'){
	          	  $('#img-staute').val(1);
	          	  flag = false;
	          	  return false;
	          }
		      if(flag){
		      	  $('#img-staute-error').remove();
		      	  $('#img-staute').val(0);
		      }
	          	  })
          $scope.find('.img-percentage').remove();

			}).on('lu:errors', function (e, error) {
				var type = error[0]['errors'][0].type;
				var errors;
           if(type == 'type'){
             errors = '只能上传图片格式';
           } else if(type == 'size'){
             errors = '上传图片不能大于'+ error[0]['errors'][0].rule/(1024*1024) +'M';
           } 

					layer.open({
						content:errors,
            time:2
					});
				})
       $('.img-box .del-img').on(tool.events.tap,function(){
       	    var $this = $(this);
       	    var $scope =  $this.closest('.img-box');
       	    var id = $this.data('imgid');
	        var cid = $('#cid').val();

       	    $this.hide();
       	    $.ajax({
       	    	type : 'post',
       	    	url : '/Homemaking-delete',
       	    	dataType : 'json',
       	    	data : { id : id , cid : cid},
       	    	timeout : 60000,
       	    	error : function(){
       	    		$this.show();
       	    		layer.open({
						content:'服务器繁忙'
					});
       	    	},
       	    	success : function(){
       	    		layer.open({
    						content:'删除图片成功'
    					});
       	    		$scope.find('img').attr('src','/Assets/Home/images/add.png');
                $scope.find('.upload-btn').prop('disabled',false);

       	    	}
       	    });

       });
       
       //更新联系方式
      var custom_validate = null;
      var codeTime = '';
      var codeTimer = null;

       $('#edit-info').each(function(){
       	  var id = $('#id').val();
       	  var phone = $('#phone-num').text();
       	  var place = $('#place-txt').text() || '请输入地址';
          var isChange = phone ? 1 : 0;
       	  var html = '<form id="alert-form" action="/Homemaking-updateContact" method="post">'
                + '<div class="panel alert-form clearfix">'/*<div cLass="input-group col-12 text-center title">更新联系方式</div>*/
                + '<div class="flex-box topBar"><div><input class="btn btn-cancle" type="button" value="取消"></div><div class="text-center bar-title">更新联系方式</div> <div class="text-right"><input class="btn public-btn" type="submit" value="更新"></div></div>'
    	        + '<div cLass="input-group col-12"> <label for="phone" class="input-group-addon">手机号</label>'
    	        + '<input class="form-control" id="phone" name="phone" type="tel" maxlength="11"  placeholder="请输入手机号" value="'+ phone +'" required>'
				+ '</div>'
				+ '<div id="code-box" cLass="input-group col-12 " '+ (isChange ? 'style="display:none"' : '' ) +'> <label for="code" class="input-group-addon">验证码</label>'
    	        + '<input class="form-control" id="code" name="code"  type="number" value="" placeholder="请输入验证码" '+ (isChange ? 'disabled="disabled"' : '' ) +' maxlength="6" required>'
    	        + '<span class="input-group-addon" style="text-align: right"><span id="get-code-btn" cLass="btn btn-default">获取验证码</span></span>'
				+ '</div>'
				+ '<div cLass="input-group col-12"><label for="place" class="input-group-addon">地&nbsp;&nbsp;址</label>'
        + '<span class="place-txt form-control">' + place + '</span>'
        + '<input class="form-control" style="display:none" id="place" name="place" type="text" placeholder="请输入地址" value="'+ place +'" maxlength="50" required>'
				+ '</div>'
				+ '<div cLass="col-12 text-center">'
				+ '<input type="hidden" name="id" value="'+ id +'">'
        		+ '<input id="changeNum" type="hidden" name="isChange" value="0">'
				/*+ '<input class="btn btn-lg btn-primary submit-btn" type="submit" value="更新">'*/
				+ '</div></div></form>';

        $(this).popup({
          content : html,
          className : 'popup-panel',
          position : 'left',
          effectClass : 'left',
          beforeHide : function(){
            $('.viewport').show();
            $('body,html').removeClass('popup-panel-color');
          },
          afterShow : function(){

            setTimeout(function(){//修复iphone键盘出现问题
              $('.viewport').hide();
              $('body,html').addClass('popup-panel-color');
            },500);
            
            codeTime = parseInt($('#time-code').val());;
            if(codeTime){
               var $codeBtn = $('#get-code-btn');
                   $codeBtn.data('disabled','true');
                   countTime($codeBtn,codeTime);
                   clearTimeout(codeTimer);
                   codeTimer = setInterval(function(){
                     countTime($codeBtn);
                   },1000);
            } else{
              codeTime = 120;
            }

            $('#alert-form .place-txt').on(tool.events.tap,function(){
               $(this).hide();
               $('#place').show().focus();
            })

            $('#alert-form #place').on('blur',function(){
              var val = $(this).val();
              if(val){
                $(this).hide();
                $('#alert-form .place-txt').html(val).show();
              }
              

            });
            $('#alert-form .btn-cancle').on(tool.events.tap,function(){
              $('#edit-info').popup('close');
            })

              $('#phone').on('keyup',function(){
                 var $this = $(this);
                 var val = $this.val();
                 if(!phone || val != phone){
                  isChange = 1;
                 } else{
                  isChange = 0;
                 }
                 $('#changeNum').val(isChange);
                 if(isChange){
                  $('#code-box').show();
                  $('#code').prop('disabled',false);
                 } else{
                  $('#code-box').hide();
                  $('#code').prop('disabled','disabled');
                 }
              })

              custom_validate = $('#alert-form').validate({
                submitHandler : function(form){
                  $('.public-btn',form).prop('disabled' , 'disabled');
                  $('.bar-title',form).text('联系方式更新中...');
                  form.submit();
                },
                 rules : {
                  phone :{
                       istelephone : true,
                       maxlength : 11
                      },
                  code : {
                     remote: {
                            url: 'Account-code',  //后台处理程序
                            type: "post",        //数据发送方式
                            dataType: "json",      //接受数据格式   
                            data: {          //要传递的数据
                              'codeVal' : function() {
                                  return $("#code").val();
                                },
                               'phoneVal' : function() {
                                  return $("#phone").val();
                                }
                            }
                       }
                  }           
                },
            messages : {
                code : {
                     required : '请输入验证码',
                     number : "请输入数字",
                     remote : "验证码错误",
                     maxlength : '验证码长度不能超过6位'    
                     },
                phone : {
                     required : '请输入手机号',
                     maxlength : '手机号码不能超过11位'
                     },
                place  : {
                     required : '请输入地址',
                     maxlength : '地址不能超过50个字'
                }   
                }  
              });
          }
        });

            /*var layerForm = layer.open({
                content:html,
                style : "max-width:500px"
              });*/
				    


       })

       function countTime(obj){

                 if(codeTime == 0){
                     clearTimeout(codeTimer);
                     codeTime = 120;
                     obj.html('重新发送');
                     obj.data('disabled','false').removeClass('disabled');
                 }
                 else{
                     obj.html('('+codeTime + 's）后重发').addClass('disabled');
                     codeTime--;
                 }
         }
       $('body').on(tool.events.tap,'#get-code-btn',function(){
        var $this = $(this);

          if (custom_validate.element('#phone')) {
            $this.data('codeflag',true);

            countTime($this,codeTime);
            $.ajax({
              type:'post',
              url: 'Account-getcode',
              data: {
                 phoneVal : $('#phone').val()
              },
              dataType:'json',
              timeout:60000,
              error:function(){
                alert('服务器繁忙');
              },
              success:function(json){
                clearTimeout(codeTimer);
                codeTimer = setInterval(function(){
                 countTime($this);
               },1000);
                }

            })

          } else{
            custom_validate.showErrors({
              phone : '手机号不正确'
            })
          };
      })
    //星级评分
    $('.star-toggle>li').on(tool.events.tap,function(){
        var $this = $(this);
        var $scope = $this.closest('.star-box');
        var val = $this.data('value');
        var $hidden = $scope.find('.star-hidden');
        var w = ($this.index()+1)*20 + '%';
        
        $scope.find('.star-inner').css('width',w);
        $scope.find('.star-txt>li').removeClass('active').eq($this.index()).addClass('active');
        $hidden.val(val);
    })

    //未支付
    $('body').on(tool.events.tap,'.unpay',function(){
         var $this = $(this);
         var id = $this.data('id');
         var flag = $this.data('flag');

         if(flag) return;
         $this.data('flag',true);

         $.ajax({
            type : 'post',
            url : '/Homemaking-unpay',
            dataType : 'json',
            data : { id : id},
            timeout : 60000,
            error : function(){
               $this.data('flag',false);
              layer.open({
                  content:'服务器繁忙'
                });
             },
            success : function(){
              $this.data('flag',false);
            }
         });

    })
    	
    //服务未结束
    $('body').on(tool.events.tap,'.noService',function(){
          layer.open({
            content : '暂未为您预约服务，还不能点评',
            time : 2
          });   
    })
    	
    //服务未结束
    $('body').on(tool.events.tap,'.noServiceEnd',function(){
          layer.open({
            content : '服务还未结束，暂不能点评。',
            time : 2
          });   
    })

		var J_comment_form = $('#J_comment-form').validate({

      highlight : function(el){
              $(el).closest('.lattice-el').addClass('error');
           },
		   rules : {
              nurse : {
              	required : true
              },
              bianbian : {
              	required : true
              },
              anmo : {
              	required : true
              },
              xiaodu : {
              	required : true
              },
              qianneng : {
              	required : true
              },
              yichang : {
              	required : true
              },
              weisheng : {
              	required : true
              },
              buru : {
              	required : true
              },
              fangjian : {
              	required : true
              },
              yuezican : {
              	required : true
              },
              xinde : {
              	required : true
              },
              chanhou : {
              	required : true
              },
              zeren : {
              	required : true
              },
              taidu : {
              	required : true
              },
              goutong : {
              	required : true
              },
              xingge : {
              	required : true
              },
              xiguan : {
              	required : true
              },
              wenming : {
              	required : true
              }
		   },
		   messages : {
		   	commentTxt : {
              	required : '评论内容不能为空',
                maxlength : '评论内容不能超过100字'
              },
              star : {
                required : '请选择星级评分'
              }      
		   },
           submitHandler : function(form){
             if($('#img-staute').val() == 1){
               
                 J_comment_form.showErrors({
                    imgStaute : '图片上传中...'
                  })
             } else{
              $(form).find('input[type="submit"]').prop('disabled','disabled');
              form.submit();
             }
			},
		})
	})
})