<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
	<title>母婴问答</title>
	<link rel="stylesheet" type="text/css" href="/Assets/Home/test/css/common.min.css">
	<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
	<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp"></script>
	<script charset="utf-8" src="http://map.qq.com/api/js?v=2.exp&libraries=convertor"></script>
	<script>
	  wx.config({
	    //debug: true,
	    appId: '<?php echo $signPackage["appId"];?>',
	    timestamp: <?php echo $signPackage["timestamp"];?>,
	    nonceStr: '<?php echo $signPackage["nonceStr"];?>',
	    signature: '<?php echo $signPackage["signature"];?>',
	    jsApiList: [
	      // 所有要调用的 API 都要加到这个列表中
	      'getLocation','openLocation'
	    ]
	  });
	  wx.ready(function () {
	    // 在这里调用 API
	    wx.getLocation({
		    success: function (res) {
		        var latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
		        var longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
		        var speed = res.speed; // 速度，以米/每秒计
		        var accuracy = res.accuracy; // 位置精度
		        codeLatLng(latitude,longitude);
		        /*wx.openLocation({
				    latitude: latitude, // 纬度，浮点数，范围为90 ~ -90
				    longitude: longitude, // 经度，浮点数，范围为180 ~ -180。
				    name: '', // 位置名
				    address: '', // 地址详情说明
				    scale: 1, // 地图缩放级别,整形值,范围从1~28。默认为最大
				    infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
				});*/
		    }
		});
	  });
	  /*
	  wx.checkJsApi({
	    jsApiList: ['getLocation'], // 需要检测的JS接口列表，所有JS接口列表见附录2,
	    success: function(res) {
	        // 以键值对的形式返回，可用的api值true，不可用为false
	        // 如：{"checkResult":{"chooseImage":true},"errMsg":"checkJsApi:ok"}
	        //console(res);
	        //alert(res);
	    }
	  });*/
	//腾讯地图反地址解析
	function codeLatLng(lat,lng) {
	    var geocoder = new qq.maps.Geocoder();
	    var latLng = new qq.maps.LatLng(lat, lng);
	    qq.maps.convertor.translate(new qq.maps.LatLng(lat, lng),1, function(res){
	    	latlng = res[0];
	    	geocoder.getAddress(latlng);
	    	geocoder.setComplete(function(result) {
	        	document.getElementById("location").value=result.detail.addressComponents.city+result.detail.addressComponents.district;
	        	//document.getElementById("location").value=result.detail.addressComponents.city+result.detail.addressComponents.district+result.detail.addressComponents.street;
	        	//alert(result.detail.address);
		        /*wx.openLocation({
				    latitude: latlng.getLat(), // 纬度，浮点数，范围为90 ~ -90
				    longitude: latlng.getLng(), // 经度，浮点数，范围为180 ~ -180。
				    name: '', // 位置名
				    address: '', // 地址详情说明
				    scale: 1, // 地图缩放级别,整形值,范围从1~28。默认为最大
				    infoUrl: '' // 在查看位置界面底部显示的超链接,可点击跳转
				});*/
	        });
	        //若服务请求失败，则运行以下函数
	        geocoder.setError(function() {
	            //alert("出错了，请输入正确的经纬度！！！");
	            document.getElementById("location").value="";
	        });
		});
	}
	</script>
</head>

<body id="regist" onload="">
	<div id="main" style="text-align:center;">
		<H1>广告页面</H1>
		<br />
		<font></font>
	</div>
	<section id="reg-wrap">
    <form id="reg-form" class="reg-form" action="Homemaking-motherBabyQAIssue" method="post">
        <div class="form-bg">
           <div class="clearfix">
           	<div class="base-horizontal  col-xs-9">
                <input id="content"  type="textarea" name="content" placeholder="请输入内容"  required >
                <span class="del-input-txt icon-sprite"></span>
                <input id="location"  type="hidden" name="location" >
           	</div>
           	<div class="base-horizontal  col-xs-3">
                <input id="x-btn" type="submit" value="发布"/>
           	</div>
           </div>
            </div>
        <input type="hidden" name="redirect" value="{$lasturl}" />
        <input id="time" type="hidden" value="{$time}" />
      <!--<input id="submit-btn" type="submit" value="提交"/>-->
    </form>
    <!--
    <div class="form-bg">
    <volist name="list" id="vo">
           <div class="clearfix">
           	<div class="base-horizontal  col-xs-3">
           		{$vo.fldContent}
           	</div>
           	<div class="base-horizontal  col-xs-3">
           		浏览（{$vo.fldViewNum}）
           	</div><div class="base-horizontal  col-xs-3">
           		回复（{$vo.fldReplyNum}）
           	</div>
           	<div class="base-horizontal  col-xs-3">
           		{$vo.fldCreateDate}
           	</div>
           </div>
    </volist>
    <div class="clearfix">
    	<div class="base-horizontal  col-xs-12">
    		<div class="result page">{$page}</div>
    	</div>
    </div>
 </div>-->
 </section>

<div class="form-bg">
    <volist name="list" id="vo">
           <div class="clearfix">
           	<div class="base-horizontal  col-xs-2">
           		<if condition="$vo.fldOpenId neq null">
           			<img src='Uploads/Weixin/{$vo.fldOpenId}.jpg' width="64px">
           		<else/>
           			<img src='Uploads/Weixin/userphoto.jpg' width="64px">
           		</if>
           		{$vo.fldOpenName}.{$vo.fldContent}
           	</div>
           	<div class="base-horizontal  col-xs-2">
           		浏览（{$vo.fldViewNum}）
           	</div>
           	<div class="base-horizontal  col-xs-2">
           		点赞（{$vo.fldLikeNum}）
           		<if condition="$vo.isLike eq 1"><a href='Homemaking-motherBabyQALike-id-{$vo.fldId}'>取消点赞</a><else/><a href='Homemaking-motherBabyQALike-id-{$vo.fldId}'>点赞</a></if>
           		<!--<?php if(in_array($vo['fldId'],$communityLike)){echo '不能点赞';}else{echo '可以点赞';} ?>-->
           	</div>
           	<div class="base-horizontal  col-xs-2">
           		回复（{$vo.fldReplyNum}）
           	</div>
           	<div class="base-horizontal  col-xs-2">
           		{$vo.fldCreateDate}
           	</div>
           	<div class="base-horizontal  col-xs-2">
           		<a href="Homemaking-motherBabyQADetail-id-{$vo.fldId}">详情</a>
           	</div>
           	<volist name="vo.reply" id="voo">
	           	<div class="base-horizontal  col-xs-12">
	           		{$i}{$voo.fldOpenName}:{$voo.fldContent}
	           	</div>
           	</volist>
           </div>
    </volist>
    
    <div class="clearfix">
    	<div class="base-horizontal  col-xs-12">
    		<div class="result page">{$page}</div>
    	</div>
    </div>
 </div>


 <script src="/Assets/Home/test/js/lib/sea.js" type="text/javascript"></script>

 <script type="text/javascript">

   seajs.use(['zepto/zepto.min','./Assets/Home/test/js/plug/h5Validate/html5Validate.min','/Assets/Home/test/js/plug/layer.m/layer.m'],function($,validate,layer){
   $(function(){
     validate($);


       $('#reg-form').html5Validate(function(){
           layer.open({
               content: '<img width="30" style="position:relative;top:8px;" src="/Assets/Home/test/images/loading.gif">数据提交中...',
               shadeClose: false
           });
           setTimeout(function(){
               layer.open({
                   content: '服务器繁忙，请重试',
                   shadeClose: false,
                   time : 2
               });
           },60000);
           this.submit();
       this.submit();
     },{
      validate : function(){
        var $phone = $('#phone');
        var phoneVal = $phone.val();
        var $code = $('#code');
        var codeVal = $code.val();
        var numReg = /^\d+$/;       
        var isReg = $phone.data('isReg');
        if(isReg != 'true' && $.html5Validate.isAllpass($phone)){
          var flag = true;
          $.ajax({
             type:'post',
             async:false,
             url : "Account-mobile",
              data:{'phoneVal':phoneVal},
              timeout : 60000,
              error : function(){
                var index = layer.open({
                  content : '<p class="text-center">服务器繁忙</p>'
                });
                setTimeout(function(){
                  layer.close(index)
                },1000)

              },
             success:function(ret){
               if(ret == 'false'){             
                   flag = false;
               }

             }
           });
             if(!flag){
              $phone.testRemind('用户已存在');
              return false;
            } 
            else{
              $phone.data('isReg','true');
            }
        }
        if(codeVal.length < 6){
          $code.testRemind('只能输入6位数字');
          return false;

        } else if(numReg.test(codeVal)){
           var flag = true;
           $.ajax({
             type:'post',
             async:false,
             url : "Account-code",
             data:{'codeVal':codeVal,'phoneVal':phoneVal},
             timeout : 60000,
             error : function(){
                var index = layer.open({
                  content : '<p class="text-center">服务器繁忙</p>'
                });
                setTimeout(function(){
                  layer.close(index)
                },1000)

              },
             success:function(ret){
               if(ret == 'false'){             
                   flag = false;
               }

             }
            
           });
            if(!flag){
              $code.testRemind('验证码不正确');
              return false;
            } 
        } 
        else{
          $code.testRemind('验证码只能为数字');
          return false;
        }

        return true;
      }

     })
   
     
       var time =  parseInt($('#time').val());
       var timer = null;
         if(time){
             var $codeBtn = $('#get-code');
             $codeBtn.data('disabled','true');
             countTime($codeBtn,time);
             timer = setInterval(function(){

                 countTime($codeBtn);
             },1000)

         }
         else{
             time = 59;
         }

         function countTime(obj){
                 if(time == 0){
                     clearTimeout(timer);
                     time = 59;
                     obj.html('重新发送');
                     obj.data('disabled','false');
                 }
                 else{
                     obj.html('('+time + 's）后重发');
                     time--;
                 }
         }
       $('#get-code').on('tap click',function(){

            var $this = $(this);
            var $phone = $('#phone');
            var phoneVal = $phone.val();
             var $time = $('#time');
             var time =parseInt($time.val());

            if($.html5Validate.isAllpass($phone)){
                if($this.data('disabled') == 'true'){
                  return;

                } 
                $this.data('disabled','true');
                $.ajax({
                     type : 'post',
                     url : 'Account-getcode',
                     data:{'phoneVal':phoneVal},
                     timeout : 60000,
                     error : function(){
                        var index = layer.open({
                          content : '<p class="text-center">服务器繁忙</p>'
                        });
                        setTimeout(function(){
                          layer.close(index)
                        },1000)

                      },
                     success : function(ret){
                         if (!ret)
                         {
                             alert("发送失败")
                             return;
                         }

                       timer = setInterval(function(){
                           countTime($this);
                       },1000)
                       
                     }

                       });

            }        

       })
       $('#phone').on('keyup',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $del =  $parent.find('.del-input-txt');
          var val = $this.val();
          $this.data('isReg','false');
          if(val != ''){
            $del.addClass('active');
          }
          else{
            $del.removeClass('active');
          }
       })
       $('.del-input-txt').on('tap',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $input =  $parent.find('input');
          $input.val('');
          $this.removeClass('active');
       });
       $('.show-psw').on('tap',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $input =  $parent.find('input');
          var type =  $input.attr('type');

          if(type == 'password'){
            $input.attr('type','text');
            $this.addClass('active');
          }
          else{
            $input.attr('type','password');
            $this.removeClass('active');
          }

       })

     })
 
   });
 </script>
</body>

</html>
