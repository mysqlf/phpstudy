<!doctype <!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
	<title>修改密码</title>
	<link rel="stylesheet" type="text/css" href="/Assets/Home/test/css/common.min.css">
  <link rel="stylesheet" type="text/css" href="/Assets/Home/test/js/plug/zepto.mobiscroll/css/mobiscroll.css">
  <link rel="stylesheet" type="text/css" href="/Assets/Home/test/js/plug/zepto.mobiscroll/css/mobiscroll_002.css">
  <link rel="stylesheet" type="text/css" href="/Assets/Home/test/js/plug/zepto.mobiscroll/css/mobiscroll_003.css">
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
</head>
<body>
 <section id="card-wrap">
    <form id="card-form" class="reg-form" action="<?php echo U('Homemaking-changePassword','','');?>" method="post">
    <input type='hidden' name='redirect' value="{$redirect}">
    <div class="pannel" style="padding-top:30px;margin-bottom:40px">
      <div class="clearfix">
      <if condition="($u eq null) OR ($p eq null)">
       <div class="base-horizontal">
              <div class="left">
                 <label for="account">手机号</label>
              </div>
              <div class="right">
                <input id="account"  type="mobile" name="account" placeholder="请输入手机号" maxlength="11" required >
                <span class="del-input-txt icon-sprite"></span>
              </div>
        </div>
         <div class="base-horizontal">
           <div class="left">
               <label  for="oldPassword">旧密码</label>
            </div>
            <div class="right">
              <input id="oldPassword" name="oldPassword" type="password" required data-max="20" data-min="6" maxlength="20">
              <span class="del-input-txt icon-sprite"></span>
            </div>
         </div>
        <else />
        	<div class="base-horizontal">
              <div class="left">
                 <label for="account">手机号</label>
              </div>
              <div class="right">
                <input id="account"  type="mobile" name="account" placeholder="请输入手机号" maxlength="11" value="{$u}" readonly required >
                <span class="del-input-txt icon-sprite"></span>
              </div>
          </div>
          <div class="base-horizontal">
           <div class="left">
               <label  for="oldPassword">旧密码</label>
            </div>
            <div class="right">
              <input id="oldPassword" name="oldPassword" type="password" required data-max="20" data-min="6" maxlength="20" value="{$p}">
              <span class="del-input-txt icon-sprite"></span>
            </div>
         </div>
        </if>
         <div class="base-horizontal">
           <div class="left">
               <label  for="newPassword">新密码</label>
            </div>
            <div class="right">
              <input id="newPassword" name="newPassword" type="password" required data-max="20" data-min="6" maxlength="20">
              <span class="del-input-txt icon-sprite"></span>
            </div>
         </div>
         <div class="base-horizontal">
           <div class="left">
               <label  for="ensurePassword">确认密码</label>
            </div>
            <div class="right">
              <input id="ensurePassword" name="ensurePassword" type="password" required data-max="20" data-min="6" maxlength="20">
              <span class="del-input-txt icon-sprite"></span>
            </div>
         </div>
    </div> 
     
    </div>
      <!--
      <div class="pannel">
        
      <div class="clearfix">
         <div class="base-horizontal col-xs-6">
              <label class="dn" for="schoolStart">入学时间</label>
              <input class="time" id="schoolStart" type="text" name='schoolStart' placeholder="入学时间 " data-initdate='2013-09-01'  readonly required >
              <span class="icon-down icon-sprite"></span>
        </div>
        <div class="base-horizontal col-xs-6">
             <label class="dn" for="schoolEnd">入学时间</label>
             <input class="time"  id="schoolEnd" type="text" name='schoolEnd' placeholder="毕业时间 " value="至今" readonly required >  
             <span class="icon-down icon-sprite"></span>
        </div>
      </div>
      <div class="base-horizontal">
        <div class="left">
           <label for="school">院校名称</label>
        </div>
        <div class="right">
          <input id="school" type="text" name="schoolName"  placeholder="请输入院校名称" required>
        </div>
      </div>
      <div id="J_specialtyBox" class="base-horizontal">
        <div class="left">
           <label for="specialty">专业名称</label>
        </div>
        <div class="right">
          <input id="specialty" type="text" name='specialty' placeholder="请输入专业名称" required>
        </div>
      </div>      
       </div>      
       -->
      <input id="submit-btn" type="submit" value="提交"/>
    </form>
 </section>
 
 <script type="text/javascript" src="/Assets/Home/js/wx/wxHideShare.js"></script>
 <script src="/Assets/Home/test/js/lib/sea.js" type="text/javascript"></script>
 <script type="text/javascript">
   seajs.use(['zepto/zepto.min','/Assets/Home/test/js/plug/iscroll/iscroll.min','/Assets/Home/test/js/plug/h5Validate/html5Validate.min','/Assets/Home/test/js/plug/zepto.mobiscroll/mobiscroll','/Assets/Home/test/js/plug/layer.m/layer.m'],function($,IScroll,validate,mobiscroll,layer){

  $(function(){

     validate($);
     $('#card-form').html5Validate(function(){
        layer.open({
              content: '<img width="30" style="position:relative;top:8px;" src="/Assets/Home/test/images/loading.gif">数据提交中...',
              shadeClose: false
            });
            setTimeout(function(){
                layer.open({
                  content: '服务器繁忙，请重试',
                  shadeClose: false,
                  time : 2
                });
            },60000);
        this.submit();
     },{
      validate : function(){
        var $name = $('#name');
        var nameVal = $name.val();
        var reg = /^[\u4e00-\u9fa5]+$/i;
        var $schoolEnd = $('#schoolEnd');
        var schoolStart = new Date($('#schoolStart').val()).getTime();
        var schoolEnd = $schoolEnd.val() == '至今' ? new Date().getFullYear() + '-' + ( parseInt(new Date().getMonth()) + 1) + '-'+new Date().getDate(): $schoolEnd .val();
        
          
          
        return true;
      }
      
     })

      var currYear = (new Date()).getFullYear(); 
      var opt={};
      opt.date = {preset : 'date'};
      opt.default = {
        theme: 'android-ics light', //皮肤样式
        startYear: currYear - 100, //开始年份
        endYear: currYear + 20 //结束年份
      };
     $('.time').each(function(){

       $(this).mobiscroll($.extend(opt['date'], opt['default']));

     })
    $('#schoolStart').on('change',function(){
      opt.default.startYear = $(this).val().split('-')[0];
      $('#schoolEnd').mobiscroll($.extend(opt['date'], opt['default']));

    })
     $('.sex-radio label').tap(function(){
        var $this = $(this);
        var $scope = $this.closest('.sex-radio');
        $scope.find('label').removeClass('active');
        $this.addClass('active');
     });
     $('.dropdown .dropdown-toggle').tap(function(){
           var $this = $(this);
           var $scope = $this.closest('.dropdown'); 
           $scope.toggleClass('open');
           $('.mask').remove();
           $('<div class="mask opacity0"></div>').tap(function(){
              $scope.toggleClass('open');
              $(this).remove();
           }).appendTo('body');

        })
    $('.dropdown .dropdown-menu>li>a').tap(function(){
      var $this = $(this);
      var $scope = $this.closest('.dropdown'); 
      var $toggle = $scope.find('.dropdown-toggle');
      var val = $this.text() ;
      var $specialtybox = $('#J_specialtyBox');
      var $specialty = $('#specialty');

      $toggle.val(val);
      if($scope.data('target') == '#specialty'){
        if( val == "高中" || val == "初中"){
          $specialtybox.hide();
            $specialty.prop('required',false).removeAttr('name');
        }
        else{
         $specialtybox.show();
         $specialty.prop('required','required').attr('name','specialty');
      }    
      }
      
      $scope.toggleClass('open');

      $scope.find('.hidden-input').val($this.data('value'));
      setTimeout(function(){
        $('.mask').remove();
      },50);
      
    }); 
    
     $('.palce-dropdown .dropdown-toggle').tap(function(){
         var $this = $(this);
         
             var isdata =  $this.data('data');
             var html = '';
             $('#card-form input').blur(); 
             if(!isdata){
                $.ajax({
                  type:'post',
                  url:'Homemaking-areaSelect',
                  data:{'code':0},
                  async:true,
                  dataType:'json',
                  success:function(json){
                    data = json;
                    if(!data) return;
                    $this.data('data','true');
                    for(var i = 0,len = data.items.length; i < len; i++){

                          var name =  data.items[i].name;
                          var code = data.items[i].code;
                          var className = parseInt(data.items[i].hasChild) > 0 ? 'class = "hasChild"' : '';
                          html +='<li><a ' + className + ' href="javascript:;" data-code="'+code+'" title="' + name + '">' + name + '</a></li>'
                      }
                    $('#place-list').find('.first-list>ul').html(html);
                    } 
                });   
             }
             $('#place-list').show().addClass('open');
             $('.mask').removeClass('opacity0').tap(function(){
                  $('#place-list').hide().removeClass('open');
                    }); 
         
         
         
     });

    var palceJsonTemp = {};

    $('body').on('tap','#place-list .place-list-inner li>a',function(){
        var $this = $(this);

              var $scope = $this.closest('.place-list-inner');
              var code = $this.data('code');
              var val = $this.html();
              var html = '';
              var isFirst = $scope.hasClass('first-list');
              var isNext = $scope.hasClass('next-list');
              
              $scope.find('li>a').removeClass('active');
              $this.addClass('active');
              $scope.next().children('ul').html('');
              $scope.next().next().children('ul').html('');
              if($this.hasClass('hasChild')){
                var hasHtml = false;
          
                    for(prop in palceJsonTemp){

                        if(prop == code){
                          hasHtml = true;
                          html =  palceJsonTemp[prop];
                          break;
                        }
                      }
                  if(hasHtml) {

                     $scope.next().children('ul').html(html);

                     return;
                  }   

                 var $box = null;
                  $.ajax({
                    type:'post',
                    url:'Homemaking-areaSelect',
                    data:{'code':code},
                    async:true,
                    dataType:'json',
                    success:function(json){
                      data = json;
                      if(!data) return;
                      for(var i = 0,len = data.items.length; i < len; i++){
                            var name =  data.items[i].name;
                            var dataCode = data.items[i].code;
                            var className = parseInt(data.items[i].hasChild) > 0 ? 'class = "hasChild"' : '';
                            html +='<li><a ' + className + '  href="javascript:;" data-code="'+dataCode+'" title="' + name + '">' + name + '</a></li>'
                        }
                      palceJsonTemp[code] = html;
                      $scope.next().children('ul').html(html);

                      } 
                  });  

                 
              }
              else{
                var valArr = [];
                
                $('#place-list li>a.active').each(function(){
                  var vals = $(this).text();
                  valArr.push(vals);
                })
                $('#place').val(valArr.join('-')).closest('.dropdown').removeClass('open');
                $('.palce-dropdown').find('.hidden-input').val(code);
                $('#place-list').removeClass('open').hide();
                setTimeout(function(){
                  $('.mask').remove();
                },50);
              }


    })
    
    
     
       var time =  parseInt($('#time').val());
       var timer = null;
         if(time){
             var $codeBtn = $('#get-code');
             $codeBtn.data('disabled','true');
             countTime($codeBtn,time);
             timer = setInterval(function(){

                 countTime($codeBtn);
             },1000)

         }
         else{
             time = 59;
         }

         function countTime(obj){
                 if(time == 0){
                     clearTimeout(timer);
                     time = 59;
                     obj.html('重新发送');
                     obj.data('disabled','false');
                 }
                 else{
                     obj.html('('+time + 's）后重发');
                     time--;
                 }
         }
       $('#get-code').on('tap click',function(){

            var $this = $(this);
            var $phone = $('#phone');
            var phoneVal = $phone.val();
             var $time = $('#time');
             var time =parseInt($time.val());

            if($.html5Validate.isAllpass($phone)){
                if($this.data('disabled') == 'true'){
                  return;

                } 
                $this.data('disabled','true');
                $.ajax({
                     type : 'post',
                     url : 'Account-getcode',
                     data:{'phoneVal':phoneVal},
                     timeout : 60000,
                     error : function(){
                        var index = layer.open({
                          content : '<p class="text-center">服务器繁忙</p>'
                        });
                        setTimeout(function(){
                          layer.close(index)
                        },1000)

                      },
                     success : function(ret){
                         if (!ret)
                         {
                             alert("发送失败")
                             return;
                         }

                       timer = setInterval(function(){
                           countTime($this);
                       },1000)
                       
                     }

                       });

            }        

       })
       $('#phone').on('keyup',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $del =  $parent.find('.del-input-txt');
          var val = $this.val();
          $this.data('isReg','false');
          if(val != ''){
            $del.addClass('active');
          }
          else{
            $del.removeClass('active');
          }
       })
       $('.del-input-txt').on('tap',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $input =  $parent.find('input');
          $input.val('');
          $this.removeClass('active');
       });
       $('.show-psw').on('tap',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $input =  $parent.find('input');
          var type =  $input.attr('type');

          if(type == 'password'){
            $input.attr('type','text');
            $this.addClass('active');
          }
          else{
            $input.attr('type','password');
            $this.removeClass('active');
          }

       })
    
      })
    
   });
 </script>
</body>
</html>

