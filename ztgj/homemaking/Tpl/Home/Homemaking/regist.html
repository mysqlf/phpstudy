<!doctype <!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no">
	<title>注册绑定</title>

	<link rel="stylesheet" type="text/css" href="/Assets/Home/test/css/common.min.css?5">
  <link rel="stylesheet" type="text/css" href="/Assets/Home/test/js/plug/zepto.mobiscroll/css/mobiscroll.css">
  <link rel="stylesheet" type="text/css" href="/Assets/Home/test/js/plug/zepto.mobiscroll/css/mobiscroll_002.css">
  <link rel="stylesheet" type="text/css" href="/Assets/Home/test/js/plug/zepto.mobiscroll/css/mobiscroll_003.css">
</head>
<body>
 <section id="card-wrap">
 	<div id="main" style="text-align:center;">
		<H1>获取你的专属身份</H1>
		<br />
		<font></font>
	</div>
    <form id="card-form" class="reg-form" action="<?php echo U('regist');?>" method="post">
    <input type='hidden' name='redirect' value="{$redirect}">
    <div class="pannel" style="padding-top:30px;margin-bottom:40px">
       <div class="base-horizontal">
              <div class="left">
                 <label for="phone">手机号</label>
              </div>
              <div class="right">
                <input id="phone"  type="mobile" name="phone" placeholder="请输入手机号" maxlength="11" required >
                <span class="del-input-txt icon-sprite"></span>
              </div>
            </div>
            <div class="base-horizontal">
              <div class="left">
                 <label for="code">验证码</label>
              </div>
              <div class="right">
                <input id="code"  type="text" name="code" placeholder="请输入验证码"  maxlength="6" required>
                <a id="get-code" href="javascript:;" title="获取验证码">获取验证码</a>
              </div>
            </div>
            <div class="base-horizontal">
              <div class="left">
                 <label for="password">密码</label>
              </div>
              <div class="right">
                <input id="password"  type="password" name="phone" placeholder="请输入密码（6-20位字母、数字或者符号）" maxlength="20" required >
                <span class="del-input-txt icon-sprite"></span>
              </div>
            </div>
    </div>

      <input id="submit-btn" type="submit" value="提交"/>
    </form>
 </section>
 <div id="datePlugin"></div>
 <div id="place-list" class="place-list">
   <div class="first-list place-list-inner col-xs-3 iscroll">
      <ul>
     </ul>
   </div>
    
   <div class="next-list place-list-inner col-xs-4 iscroll">
     <ul>

    </ul>
   </div>
   <div class="third-list place-list-inner col-xs-5 iscroll">
     <ul>

    </ul>
   </div>
 </div>
 <script src="/Assets/Home/test/js/lib/sea.js" type="text/javascript"></script>
 <script type="text/javascript">
   seajs.use(['zepto/zepto.min','/Assets/Home/test/js/plug/iscroll/iscroll.min','/Assets/Home/test/js/plug/h5Validate/html5Validate.min','/Assets/Home/test/js/plug/zepto.mobiscroll/mobiscroll','/Assets/Home/test/js/plug/layer.m/layer.m'],function($,IScroll,validate,mobiscroll,layer){

  $(function(){

     validate($);
     $('#card-form').html5Validate(function(){
        layer.open({
              content: '<img width="30" style="position:relative;top:8px;" src="/Assets/Home/test/images/loading.gif">数据提交中...',
              shadeClose: false
            });
            setTimeout(function(){
                layer.open({
                  content: '服务器繁忙，请重试',
                  shadeClose: false,
                  time : 2
                });
            },60000);
        this.submit();
     },{
      validate : function(){
        return true;
        /*
        var $phone = $('#phone');
        var phoneVal = $phone.val();
        var $code = $('#code');
        var codeVal = $code.val();
        var numReg = /^\d+$/;       
        var isReg = $phone.data('isReg');
        if(isReg != 'true' && $.html5Validate.isAllpass($phone)){
          var flag = true;
          $.ajax({
             type:'post',
             async:false,
             url : "Account-mobile",
              data:{'phoneVal':phoneVal},
              timeout : 60000,
              error : function(){
                var index = layer.open({
                  content : '<p class="text-center">服务器繁忙</p>'
                });
                setTimeout(function(){
                  layer.close(index)
                },1000)

              },
             success:function(ret){
               if(ret == 'false'){             
                   flag = false;
               }

             }
           });
             if(!flag){
              $phone.testRemind('用户已存在');
              return false;
            } 
            else{
              $phone.data('isReg','true');
            }
        }
        if(codeVal.length < 6){
          $code.testRemind('只能输入6位数字');
          return false;

        } else if(numReg.test(codeVal)){
           var flag = true;
           $.ajax({
             type:'post',
             async:false,
             url : "Account-code",
             data:{'codeVal':codeVal,'phoneVal':phoneVal},
             timeout : 60000,
             error : function(){
                var index = layer.open({
                  content : '<p class="text-center">服务器繁忙</p>'
                });
                setTimeout(function(){
                  layer.close(index)
                },1000)

              },
             success:function(ret){
               if(ret == 'false'){             
                   flag = false;
               }

             }
            
           });
            if(!flag){
              $code.testRemind('验证码不正确');
              return false;
            } 
        } 
        else{
          $code.testRemind('验证码只能为数字');
          return false;
        }
          
        return true;*/
      }
      
     })

      var currYear = (new Date()).getFullYear(); 
      var opt={};
      opt.date = {preset : 'date'};
      opt.default = {
        theme: 'android-ics light', //皮肤样式
        startYear: currYear - 100, //开始年份
        endYear: currYear + 20 //结束年份
      };
     $('.time').each(function(){

       $(this).mobiscroll($.extend(opt['date'], opt['default']));

     })
    $('#schoolStart').on('change',function(){
      opt.default.startYear = $(this).val().split('-')[0];
      $('#schoolEnd').mobiscroll($.extend(opt['date'], opt['default']));

    })
     $('.sex-radio label').tap(function(){
        var $this = $(this);
        var $scope = $this.closest('.sex-radio');
        $scope.find('label').removeClass('active');
        $this.addClass('active');
     });
     $('.dropdown .dropdown-toggle').tap(function(){
           var $this = $(this);
           var $scope = $this.closest('.dropdown'); 
           $scope.toggleClass('open');
           $('.mask').remove();
           $('<div class="mask opacity0"></div>').tap(function(){
              $scope.toggleClass('open');
              $(this).remove();
           }).appendTo('body');

        })
    $('.dropdown .dropdown-menu>li>a').tap(function(){
      var $this = $(this);
      var $scope = $this.closest('.dropdown'); 
      var $toggle = $scope.find('.dropdown-toggle');
      var val = $this.text() ;
      var $specialtybox = $('#J_specialtyBox');
      var $specialty = $('#specialty');

      $toggle.val(val);
      if($scope.data('target') == '#specialty'){
        if( val == "高中" || val == "初中"){
          $specialtybox.hide();
            $specialty.prop('required',false).removeAttr('name');
        }
        else{
         $specialtybox.show();
         $specialty.prop('required','required').attr('name','specialty');
      }    
      }
      
      $scope.toggleClass('open');

      $scope.find('.hidden-input').val($this.data('value'));
      setTimeout(function(){
        $('.mask').remove();
      },50);
      
    }); 
    
     $('.palce-dropdown .dropdown-toggle').tap(function(){
         var $this = $(this);
         
             var isdata =  $this.data('data');
             var html = '';
             $('#card-form input').blur(); 
             if(!isdata){
                $.ajax({
                  type:'post',
                  url:'Homemaking-areaSelect',
                  data:{'code':0},
                  async:true,
                  dataType:'json',
                  success:function(json){
                    data = json;
                    if(!data) return;
                    $this.data('data','true');
                    for(var i = 0,len = data.items.length; i < len; i++){

                          var name =  data.items[i].name;
                          var code = data.items[i].code;
                          var className = parseInt(data.items[i].hasChild) > 0 ? 'class = "hasChild"' : '';
                          html +='<li><a ' + className + ' href="javascript:;" data-code="'+code+'" title="' + name + '">' + name + '</a></li>'
                      }
                    $('#place-list').find('.first-list>ul').html(html);
                    } 
                });   
             }
             $('#place-list').show().addClass('open');
             $('.mask').removeClass('opacity0').tap(function(){
                  $('#place-list').hide().removeClass('open');
                    }); 
         
         
         
     });

    var palceJsonTemp = {};

    $('body').on('tap','#place-list .place-list-inner li>a',function(){
        var $this = $(this);

              var $scope = $this.closest('.place-list-inner');
              var code = $this.data('code');
              var val = $this.html();
              var html = '';
              var isFirst = $scope.hasClass('first-list');
              var isNext = $scope.hasClass('next-list');
              
              $scope.find('li>a').removeClass('active');
              $this.addClass('active');
              $scope.next().children('ul').html('');
              $scope.next().next().children('ul').html('');
              if($this.hasClass('hasChild')){
                var hasHtml = false;
          
                    for(prop in palceJsonTemp){

                        if(prop == code){
                          hasHtml = true;
                          html =  palceJsonTemp[prop];
                          break;
                        }
                      }
                  if(hasHtml) {

                     $scope.next().children('ul').html(html);

                     return;
                  }   

                 var $box = null;
                  $.ajax({
                    type:'post',
                    url:'Homemaking-areaSelect',
                    data:{'code':code},
                    async:true,
                    dataType:'json',
                    success:function(json){
                      data = json;
                      if(!data) return;
                      for(var i = 0,len = data.items.length; i < len; i++){
                            var name =  data.items[i].name;
                            var dataCode = data.items[i].code;
                            var className = parseInt(data.items[i].hasChild) > 0 ? 'class = "hasChild"' : '';
                            html +='<li><a ' + className + '  href="javascript:;" data-code="'+dataCode+'" title="' + name + '">' + name + '</a></li>'
                        }
                      palceJsonTemp[code] = html;
                      $scope.next().children('ul').html(html);

                      } 
                  });  

                 
              }
              else{
                var valArr = [];
                
                $('#place-list li>a.active').each(function(){
                  var vals = $(this).text();
                  valArr.push(vals);
                })
                $('#place').val(valArr.join('-')).closest('.dropdown').removeClass('open');
                $('.palce-dropdown').find('.hidden-input').val(code);
                $('#place-list').removeClass('open').hide();
                setTimeout(function(){
                  $('.mask').remove();
                },50);
              }


    })
    
    
     
       var time =  parseInt($('#time').val());
       var timer = null;
         if(time){
             var $codeBtn = $('#get-code');
             $codeBtn.data('disabled','true');
             countTime($codeBtn,time);
             timer = setInterval(function(){

                 countTime($codeBtn);
             },1000)

         }
         else{
             time = 59;
         }

         function countTime(obj){
                 if(time == 0){
                     clearTimeout(timer);
                     time = 59;
                     obj.html('重新发送');
                     obj.data('disabled','false');
                 }
                 else{
                     obj.html('('+time + 's）后重发');
                     time--;
                 }
         }
       $('#get-code').on('tap click',function(){

            var $this = $(this);
            var $phone = $('#phone');
            var phoneVal = $phone.val();
             var $time = $('#time');
             var time =parseInt($time.val());

            if($.html5Validate.isAllpass($phone)){
                if($this.data('disabled') == 'true'){
                  return;

                } 
                $this.data('disabled','true');
                $.ajax({
                     type : 'post',
                     url : 'Account-getcode',
                     data:{'phoneVal':phoneVal},
                     timeout : 60000,
                     error : function(){
                        var index = layer.open({
                          content : '<p class="text-center">服务器繁忙</p>'
                        });
                        setTimeout(function(){
                          layer.close(index)
                        },1000)

                      },
                     success : function(ret){
                         if (!ret)
                         {
                             alert("发送失败")
                             return;
                         }

                       timer = setInterval(function(){
                           countTime($this);
                       },1000)
                       
                     }

                       });

            }        

       })
       $('#phone').on('keyup',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $del =  $parent.find('.del-input-txt');
          var val = $this.val();
          $this.data('isReg','false');
          if(val != ''){
            $del.addClass('active');
          }
          else{
            $del.removeClass('active');
          }
       })
       $('.del-input-txt').on('tap',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $input =  $parent.find('input');
          $input.val('');
          $this.removeClass('active');
       });
       $('.show-psw').on('tap',function(){
          var $this = $(this);
          var $parent = $this.parent();
          var $input =  $parent.find('input');
          var type =  $input.attr('type');

          if(type == 'password'){
            $input.attr('type','text');
            $this.addClass('active');
          }
          else{
            $input.attr('type','password');
            $this.removeClass('active');
          }

       })
    
      })
    
   });
 </script>
</body>
</html>

